cmake_minimum_required(VERSION 3.0)

set( METABUF_LIB_NAME metabuf )

OPTION( METABUF_EXTERNAL_BUILD "METABUF_EXTERNAL_BUILD" OFF )
OPTION( METABUF_METAGEN "METABUF_METAGEN" OFF )
OPTION( METABUF_PUGIXML_INCLUDE "METABUF_PUGIXML_INCLUDE" "" )
OPTION( METABUF_PUGIXML_LIB "METABUF_PUGIXML_LIB" "" )

IF( NOT METABUF_EXTERNAL_BUILD )
    SET( CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/build_temp/${ENGINE_LIB_DIR} )
    SET( CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/bin/metabuf_win32 )
    SET( CMAKE_TEMP_DIR ${CMAKE_CURRENT_SOURCE_DIR}/CMakeTemp/metabuf_win32/${CMAKE_GENERATOR}/${CMAKE_BUILD_TYPE} )
ENDIF()


SET( METABUF_SOURCE_FILES ${METABUF_SOURCE_FILES} metabuf/Metaconfig.hpp )
SET( METABUF_SOURCE_FILES ${METABUF_SOURCE_FILES} metabuf/Metadata.cpp )
SET( METABUF_SOURCE_FILES ${METABUF_SOURCE_FILES} metabuf/Metadata.hpp )
SET( METABUF_SOURCE_FILES ${METABUF_SOURCE_FILES} metabuf/Reader.hpp )

INCLUDE_DIRECTORIES( ${METABUF_LIB_NAME} metabuf )

ADD_LIBRARY( ${METABUF_LIB_NAME} STATIC ${METABUF_SOURCE_FILES} )


if( METABUF_METAGEN )
    set( XML2METABUF_LIB_NAME xml2metabuf )
    
    set( XML2METABUF_SOURCE_FILES ${XML2METABUF_SOURCE_FILES} xml2metabuf/Xml2Metabuf.cpp )
    set( XML2METABUF_SOURCE_FILES ${XML2METABUF_SOURCE_FILES} xml2metabuf/Xml2Metabuf.hpp )
    set( XML2METABUF_SOURCE_FILES ${XML2METABUF_SOURCE_FILES} xml2metabuf/Xml2Metacode.cpp )
    set( XML2METABUF_SOURCE_FILES ${XML2METABUF_SOURCE_FILES} xml2metabuf/Xml2Metacode.hpp )
    set( XML2METABUF_SOURCE_FILES ${XML2METABUF_SOURCE_FILES} xml2metabuf/XmlProtocol.cpp )
    set( XML2METABUF_SOURCE_FILES ${XML2METABUF_SOURCE_FILES} xml2metabuf/XmlProtocol.hpp )
    
    INCLUDE_DIRECTORIES( ${XML2METABUF_LIB_NAME} xml2metabuf )
    INCLUDE_DIRECTORIES( ${XML2METABUF_LIB_NAME} ${METABUF_PUGIXML_INCLUDE} )
    
    ADD_LIBRARY( ${XML2METABUF_LIB_NAME} STATIC ${XML2METABUF_SOURCE_FILES} )
    
    TARGET_LINK_LIBRARIES( ${METAGEN_LIB_NAME} ${METABUF_LIB_NAME} )
    
    set( METAGEN_LIB_NAME metagen )
    
    set( METAGEN_SOURCE_FILES ${METAGEN_SOURCE_FILES} metagen/metagen.cpp )

    INCLUDE_DIRECTORIES( ${METAGEN_LIB_NAME} metagen )
    INCLUDE_DIRECTORIES( ${METAGEN_LIB_NAME} ${METABUF_PUGIXML_INCLUDE} )

    ADD_EXECUTABLE( ${METAGEN_LIB_NAME} ${METAGEN_SOURCE_FILES} )

    set_target_properties( ${METAGEN_LIB_NAME} PROPERTIES LINK_FLAGS "/SUBSYSTEM:CONSOLE")
    set_target_properties( ${METAGEN_LIB_NAME} PROPERTIES COMPILE_DEFINITIONS "_CONSOLE")
    
    TARGET_LINK_LIBRARIES( ${METAGEN_LIB_NAME} ${XML2METABUF_LIB_NAME} )
    TARGET_LINK_LIBRARIES( ${METAGEN_LIB_NAME} ${METABUF_PUGIXML_LIB} )
endif()